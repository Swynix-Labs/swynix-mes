<style>
/* ERPNext-style Melting Kiosk */
.melting-kiosk {
	padding: 15px;
	background: var(--bg-color, #f5f7fa);
	min-height: calc(100vh - 60px);
}

/* Header - Compact */
.mk-header {
	background: var(--card-bg, #fff);
	border: 1px solid var(--border-color, #d1d8dd);
	border-radius: var(--border-radius, 8px);
	padding: 10px 15px;
	margin-bottom: 15px;
	display: flex;
	align-items: center;
	gap: 15px;
}

.mk-header .filters {
	display: flex;
	align-items: center;
	gap: 8px;
	flex-wrap: nowrap;
}

.mk-header .filter-group {
	display: flex;
	align-items: center;
	gap: 6px;
}

.mk-header label {
	font-weight: 500;
	font-size: 12px;
	color: var(--text-muted, #6c757d);
	margin: 0;
	white-space: nowrap;
}

.mk-header .form-control {
	height: 28px;
	border-radius: var(--border-radius-sm, 4px);
	border: 1px solid var(--border-color, #d1d8dd);
	min-width: 120px;
	font-size: 12px;
	padding: 0 8px;
}

.mk-header .btn-sm {
	height: 28px;
	padding: 0 10px;
	font-size: 12px;
}

/* Sidebar panels */
.mk-sidebar-panel {
	background: var(--card-bg, #fff);
	border: 1px solid var(--border-color, #d1d8dd);
	border-radius: var(--border-radius, 8px);
	margin-bottom: 15px;
	overflow: hidden;
}

.mk-sidebar-panel .panel-head {
	background: var(--bg-color, #f5f7fa);
	padding: 12px 15px;
	border-bottom: 1px solid var(--border-color, #d1d8dd);
	font-weight: 600;
	font-size: 13px;
	color: var(--text-color, #333);
	display: flex;
	align-items: center;
	gap: 8px;
}

.mk-sidebar-panel .panel-body {
	padding: 0;
	max-height: 280px;
	overflow-y: auto;
}

/* Casting Plan Cards */
.mk-plan-item {
	padding: 12px 15px;
	border-bottom: 1px solid var(--border-color, #d1d8dd);
	cursor: pointer;
	transition: background 0.15s;
	border-left: 3px solid transparent;
}

.mk-plan-item:hover {
	background: var(--bg-color, #f5f7fa);
}

.mk-plan-item:last-child {
	border-bottom: none;
}

.mk-plan-item.has-batch {
	border-left-color: var(--green-500, #28a745);
	background: var(--green-50, #f0fff4);
}

.mk-plan-item:not(.has-batch) {
	border-left-color: var(--yellow-500, #ffc107);
}

.mk-plan-item .plan-title {
	font-weight: 600;
	font-size: 13px;
	color: var(--text-color, #333);
	margin-bottom: 4px;
}

.mk-plan-item .plan-meta {
	font-size: 11px;
	color: var(--text-muted, #6c757d);
	margin-bottom: 6px;
}

.mk-plan-item .plan-specs {
	font-size: 11px;
	color: var(--text-muted, #6c757d);
	margin-bottom: 8px;
}

.mk-plan-item .plan-footer {
	display: flex;
	justify-content: space-between;
	align-items: center;
}

.mk-plan-item .badge {
	font-size: 10px;
	padding: 3px 8px;
	border-radius: 10px;
	font-weight: 600;
	text-transform: uppercase;
}

.mk-plan-item .badge-planned {
	background: var(--yellow-100, #fff3cd);
	color: var(--yellow-700, #856404);
}

.mk-plan-item .badge-started {
	background: var(--green-100, #d4edda);
	color: var(--green-700, #155724);
}

.mk-plan-item .btn-start {
	padding: 4px 10px;
	font-size: 11px;
	border-radius: 4px;
	font-weight: 500;
}

/* Batch List */
.mk-batch-item {
	padding: 12px 15px;
	border-bottom: 1px solid var(--border-color, #d1d8dd);
	cursor: pointer;
	transition: background 0.15s;
	display: flex;
	justify-content: space-between;
	align-items: center;
}

.mk-batch-item:hover {
	background: var(--bg-color, #f5f7fa);
}

.mk-batch-item:last-child {
	border-bottom: none;
}

.mk-batch-item.active {
	background: var(--blue-50, #e3f2fd);
	border-left: 3px solid var(--primary, #2490ef);
}

.mk-batch-item .batch-info {
	flex: 1;
}

.mk-batch-item .batch-name {
	font-weight: 600;
	font-size: 13px;
	color: var(--text-color, #333);
}

.mk-batch-item .batch-meta {
	font-size: 11px;
	color: var(--text-muted, #6c757d);
}

.mk-batch-item .batch-status {
	font-size: 10px;
	padding: 3px 8px;
	border-radius: 10px;
	font-weight: 600;
	text-transform: uppercase;
}

.batch-status-charging { background: #dbeafe; color: #1d4ed8; }
.batch-status-melting { background: #ffedd5; color: #c2410c; }
.batch-status-ready { background: #fef3c7; color: #b45309; }
.batch-status-transferred { background: #d1fae5; color: #047857; }

/* Furnace Busy/Free Indicator */
.mk-furnace-indicator {
	font-size: 11px;
	padding: 4px 10px;
	border-radius: 12px;
	font-weight: 600;
	margin-left: 10px;
	display: inline-flex;
	align-items: center;
	gap: 5px;
}

.mk-furnace-busy {
	background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
	color: #dc2626;
	border: 1px solid #fecaca;
	animation: pulse-busy 2s infinite;
}

.mk-furnace-free {
	background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
	color: #16a34a;
	border: 1px solid #bbf7d0;
}

@keyframes pulse-busy {
	0%, 100% { opacity: 1; }
	50% { opacity: 0.7; }
}

/* Spectro Table Wrapper - Responsive */
.mk-spectro-table-wrapper {
	width: 100%;
	overflow-x: auto;
	overflow-y: visible;
	-webkit-overflow-scrolling: touch;
}

.mk-spectro-table-wrapper table {
	min-width: 800px; /* Ensure minimum width for readability */
}

/* Spectro Table Styles */
.mk-spectro-table {
	font-size: 12px;
	width: 100%;
}

.mk-spectro-table .mk-element-header {
	text-align: center;
	padding: 8px 6px !important;
	min-width: 65px;
	vertical-align: top;
}

.mk-spectro-table .mk-element-label {
	font-weight: 600;
	font-size: 12px;
	color: var(--text-color, #333);
	margin-bottom: 2px;
}

.mk-spectro-table .mk-element-spec {
	font-size: 10px;
	color: #64748b;
	font-weight: normal;
	white-space: nowrap;
}

.mk-spectro-table .mk-sample-val {
	text-align: center;
	font-family: monospace;
	font-size: 11px;
	padding: 8px 4px !important;
}

.mk-spectro-table .mk-sample-val.mk-in-spec {
	background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
	color: #047857;
	font-weight: 500;
}

.mk-spectro-table .mk-sample-val.mk-out-of-spec {
	background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
	color: #dc2626;
	font-weight: 700;
}

.mk-spectro-table .mk-row-has-issues {
	border-left: 3px solid #ef4444;
}

.mk-spectro-table .mk-spec-summary-row {
	background: #fef2f2 !important;
}

.mk-spectro-table .mk-spec-summary-row td {
	padding: 8px 12px !important;
	border-top: none !important;
}

.mk-spectro-table .mk-spec-summary-row:hover td {
	background: #fef2f2 !important;
}

/* Deviation specs in summary row */
.mk-spectro-table .mk-spec-summary-row .deviation-card {
	display: inline-block;
	background: #fff;
	border-left: 3px solid #ef4444;
	padding: 6px 10px;
	border-radius: 4px;
	font-size: 11px;
	margin-right: 8px;
	margin-bottom: 4px;
	box-shadow: 0 1px 2px rgba(0,0,0,0.05);
}

.mk-spectro-table .mk-spec-summary-row .deviation-card.warn {
	border-left-color: #f59e0b;
}

.mk-spectro-table .mk-spec-summary-row .deviation-card.good {
	border-left-color: #10b981;
}

/* Main Content Panel */
.mk-main-panel {
	background: var(--card-bg, #fff);
	border: 1px solid var(--border-color, #d1d8dd);
	border-radius: var(--border-radius, 8px);
}

.mk-main-panel .panel-head {
	background: var(--bg-color, #f5f7fa);
	padding: 12px 15px;
	border-bottom: 1px solid var(--border-color, #d1d8dd);
	display: flex;
	justify-content: space-between;
	align-items: center;
	flex-wrap: wrap;
	gap: 10px;
}

.mk-main-panel .batch-title {
	font-weight: 600;
	font-size: 16px;
	color: var(--text-color, #333);
	display: flex;
	align-items: center;
	gap: 10px;
	margin: 0;
}

.mk-main-panel .linked-plan {
	font-size: 12px;
	color: var(--text-muted, #6c757d);
}

/* Summary Grid */
.mk-summary-grid {
	display: grid;
	grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
	gap: 1px;
	background: var(--border-color, #d1d8dd);
	border-bottom: 1px solid var(--border-color, #d1d8dd);
}

.mk-summary-grid .summary-item {
	background: var(--card-bg, #fff);
	padding: 15px;
	text-align: center;
}

.mk-summary-grid .summary-label {
	font-size: 10px;
	color: var(--text-muted, #6c757d);
	text-transform: uppercase;
	letter-spacing: 0.5px;
	margin-bottom: 4px;
}

.mk-summary-grid .summary-value {
	font-size: 18px;
	font-weight: 700;
	color: var(--text-color, #333);
}

/* Action Buttons */
.mk-actions {
	padding: 15px;
	display: flex;
	flex-wrap: wrap;
	gap: 8px;
	border-bottom: 1px solid var(--border-color, #d1d8dd);
}

.mk-actions .btn {
	padding: 8px 16px;
	font-size: 13px;
	font-weight: 500;
	border-radius: var(--border-radius-sm, 4px);
	display: inline-flex;
	align-items: center;
	gap: 6px;
	cursor: pointer;
}

.mk-actions .btn:disabled {
	opacity: 0.5;
	cursor: not-allowed;
}

.btn-burner { background: #28a745; border-color: #28a745; color: #fff; }
.btn-burner:hover:not(:disabled) { background: #218838; }
.btn-fluxing { background: #17a2b8; border-color: #17a2b8; color: #fff; }
.btn-fluxing:hover:not(:disabled) { background: #138496; }
.btn-sample { background: #ffc107; border-color: #ffc107; color: #212529; }
.btn-sample:hover:not(:disabled) { background: #e0a800; }
.btn-correction { background: #6f42c1; border-color: #6f42c1; color: #fff; }
.btn-correction:hover:not(:disabled) { background: #5a32a3; }
.btn-ready { background: #2490ef; border-color: #2490ef; color: #fff; }
.btn-ready:hover:not(:disabled) { background: #1a73e8; }

/* Tabs - ERPNext style */
.mk-tabs {
	border-bottom: 1px solid var(--border-color, #d1d8dd);
	padding: 0 15px;
	display: flex;
	gap: 0;
	background: var(--card-bg, #fff);
}

.mk-tabs .mk-tab {
	padding: 12px 20px;
	font-size: 13px;
	font-weight: 500;
	color: var(--text-muted, #6c757d);
	cursor: pointer;
	border-bottom: 2px solid transparent;
	transition: all 0.15s;
	display: inline-flex;
	align-items: center;
	gap: 6px;
	background: none;
	border-top: none;
	border-left: none;
	border-right: none;
}

.mk-tabs .mk-tab:hover {
	color: var(--text-color, #333);
	background: var(--bg-color, #f5f7fa);
}

.mk-tabs .mk-tab.active {
	color: var(--primary, #2490ef);
	border-bottom-color: var(--primary, #2490ef);
}

/* Tab Content */
.mk-tab-content {
	padding: 15px;
	min-height: 200px;
}

.mk-tab-pane {
	display: none;
}

.mk-tab-pane.active {
	display: block;
}

/* Tab Actions */
.mk-tab-actions {
	margin-bottom: 15px;
	display: flex;
	gap: 8px;
	flex-wrap: wrap;
}

/* Tables - ERPNext style */
.mk-table {
	width: 100%;
	border-collapse: collapse;
	font-size: 12px;
}

.mk-table th {
	background: var(--bg-color, #f5f7fa);
	padding: 10px 12px;
	text-align: left;
	font-weight: 600;
	color: var(--text-muted, #6c757d);
	text-transform: uppercase;
	font-size: 11px;
	letter-spacing: 0.3px;
	border-bottom: 1px solid var(--border-color, #d1d8dd);
}

.mk-table td {
	padding: 10px 12px;
	border-bottom: 1px solid var(--border-color, #d1d8dd);
	color: var(--text-color, #333);
}

.mk-table tr:hover td {
	background: var(--bg-color, #f5f7fa);
}

.mk-table .text-right {
	text-align: right;
}

.mk-table .text-bold {
	font-weight: 600;
}

/* Empty State */
.mk-empty {
	text-align: center;
	padding: 40px 20px;
	color: var(--text-muted, #6c757d);
}

.mk-empty .empty-icon {
	font-size: 40px;
	margin-bottom: 15px;
	opacity: 0.4;
}

.mk-empty .empty-text {
	font-size: 13px;
	margin-bottom: 15px;
}

/* Form styles */
.mk-form-group {
	margin-bottom: 15px;
}

.mk-form-group label {
	display: block;
	font-weight: 500;
	font-size: 12px;
	color: var(--text-muted, #6c757d);
	margin-bottom: 5px;
}

.mk-form-group .form-control {
	width: 100%;
	max-width: 300px;
	height: 32px;
	border-radius: var(--border-radius-sm, 4px);
	border: 1px solid var(--border-color, #d1d8dd);
	padding: 0 10px;
	font-size: 13px;
}

.mk-form-group textarea.form-control {
	height: auto;
	padding: 8px 10px;
}

/* Responsive */
@media (max-width: 768px) {
	.mk-header {
		flex-direction: column;
		align-items: stretch;
	}
	
	.mk-header .filters {
		flex-wrap: wrap;
	}
	
	.mk-actions {
		flex-wrap: wrap;
	}
	
	.mk-tabs {
		overflow-x: auto;
	}
	
	.mk-summary-grid {
		grid-template-columns: repeat(3, 1fr);
	}
	
	.mk-spectro-table-wrapper {
		overflow-x: auto;
		-webkit-overflow-scrolling: touch;
	}
	
	.mk-spectro-table-wrapper table {
		min-width: 600px;
	}
}

/* QC Feedback Card Styles */
.mk-qc-feedback.hide {
  display: none;
}

.mk-qc-detail-panel.hide {
  display: none;
}

.mk-qc-detail-panel .card {
  border: 1px solid #d1d8dd;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.mk-qc-detail-panel ul li {
  padding: 4px 0;
  border-bottom: 1px solid #f0f0f0;
}

.mk-qc-detail-panel ul li:last-child {
  border-bottom: none;
}

.mk-qc-deviation-list {
	max-height: 300px;
	overflow-y: auto;
}

.mk-qc-deviation-list .qc-dev-card {
	border-radius: 6px;
	padding: 6px 10px;
	margin-bottom: 4px;
	font-size: 12px;
}

.mk-qc-deviation-list .qc-dev-card.bad {
	background-color: #ffe5e5;
	border-left: 3px solid #ef4444;
}

.mk-qc-deviation-list .qc-dev-card.warn {
	background-color: #fff3cd;
	border-left: 3px solid #f59e0b;
}

.mk-qc-deviation-list .qc-dev-card.good {
	background-color: #e5ffe8;
	border-left: 3px solid #10b981;
}
</style>

<div class="melting-kiosk">
	<!-- Header - Compact -->
	<div class="mk-header">
		<div class="filters">
			<div class="filter-group">
				<label>Furnace</label>
				<select id="mk_furnace_select" class="form-control"></select>
			</div>
			<div class="filter-group">
				<label>Date</label>
				<input type="date" id="mk_plan_date" class="form-control">
			</div>
			<button type="button" class="btn btn-default btn-sm" id="mk_btn_refresh">
				<i class="fa fa-refresh"></i>
			</button>
		</div>
	</div>

	<div class="row">
		<!-- Left Sidebar -->
		<div class="col-md-4">
			<!-- Casting Plans -->
			<div class="mk-sidebar-panel">
				<div class="panel-head">
					<i class="fa fa-calendar-check-o" style="color: #f59e0b;"></i>
					Casting Plan (Today)
				</div>
				<div class="panel-body" id="mk_cast_plan_container">
					<div class="mk-empty">
						<div class="empty-icon"><i class="fa fa-calendar-o"></i></div>
						<div class="empty-text">Select a furnace to see casting plans</div>
					</div>
				</div>
			</div>

			<!-- Batches -->
			<div class="mk-sidebar-panel">
				<div class="panel-head">
					<i class="fa fa-fire" style="color: #ef4444;"></i>
					Batches (Today)
				</div>
				<div class="panel-body" id="mk_batch_list_container">
					<div class="mk-empty">
						<div class="empty-icon"><i class="fa fa-inbox"></i></div>
						<div class="empty-text">Select a furnace to see batches</div>
					</div>
				</div>
			</div>
		</div>

		<!-- Main Content -->
		<div class="col-md-8">
			<div class="mk-main-panel">
				<!-- Batch Header -->
				<div class="panel-head">
					<h4 class="batch-title" id="mk_batch_title">
						<i class="fa fa-fire" style="color: #ef4444;"></i>
						<span>No batch selected</span>
					</h4>
				</div>

				<!-- Summary Grid -->
				<div id="mk_batch_summary">
					<div class="mk-empty" style="padding: 30px;">
						<div class="empty-icon"><i class="fa fa-hand-pointer-o"></i></div>
						<div class="empty-text">Select a batch from the list to view details</div>
					</div>
				</div>

				<!-- Action Buttons -->
				<div class="mk-actions" id="mk_action_buttons" style="display: none;">
					<button type="button" class="btn btn-burner" id="mk_btn_burner_on">
						<i class="fa fa-fire"></i> Burner Start
					</button>
					<button type="button" class="btn btn-fluxing" id="mk_btn_fluxing">
						<i class="fa fa-flask"></i> Fluxing
					</button>
					<button type="button" class="btn btn-sample" id="mk_btn_sample">
						<i class="fa fa-eyedropper"></i> Sample
					</button>
					<button type="button" class="btn btn-correction" id="mk_btn_correction">
						<i class="fa fa-plus-circle"></i> Correction
					</button>
					<button type="button" class="btn btn-ready" id="mk_btn_ready_transfer">
						<i class="fa fa-check-circle"></i> Ready for Transfer
					</button>
				</div>

				<!-- Tabs -->
				<div class="mk-tabs" id="mk_batch_tabs">
					<button type="button" class="mk-tab active" data-tab="raw">
						<i class="fa fa-cubes"></i> Raw Material
					</button>
					<button type="button" class="mk-tab" data-tab="process">
						<i class="fa fa-list-ol"></i> Process Log
					</button>
					<button type="button" class="mk-tab" data-tab="spectro">
						<i class="fa fa-flask"></i> Spectro Samples
					</button>
					<button type="button" class="mk-tab" data-tab="transfer">
						<i class="fa fa-truck"></i> Transfer
					</button>
				</div>

				<!-- Tab Content -->
				<div class="mk-tab-content">
					<!-- Raw Material Tab -->
					<div id="mk_tab_raw" class="mk-tab-pane active">
						<div class="mk-tab-actions">
							<button type="button" class="btn btn-default btn-sm" id="mk_btn_add_rm">
								<i class="fa fa-plus"></i> Scan / Add Raw Material
							</button>
							<button type="button" class="btn btn-success btn-sm" id="mk_btn_charging_complete">
								<i class="fa fa-check"></i> Charging Complete
							</button>
						</div>
						<div id="mk_raw_table"></div>
					</div>

					<!-- Process Log Tab -->
					<div id="mk_tab_process" class="mk-tab-pane">
						<div id="mk_process_table"></div>
					</div>

					<!-- Spectro Samples Tab -->
					<div id="mk_tab_spectro" class="mk-tab-pane">
						<div class="mk-spectro-table-wrapper">
							<div id="mk_spectro_table"></div>
						</div>
						
						<!-- QC Detail Panel for Selected Sample -->
						<div class="mk-qc-detail-panel hide" id="mk-qc-detail-panel" style="margin-top: 20px;">
							<div class="card">
								<div class="card-body">
									<div class="d-flex justify-content-between align-items-center mb-3">
										<h5 class="mb-0">
											QC Summary for <span id="mk-qc-detail-sample-id"></span>
										</h5>
										<button type="button" class="btn btn-xs btn-default" id="mk-qc-detail-close">
											<i class="fa fa-times"></i> Close
										</button>
									</div>
									
									<div id="mk-qc-detail-deviations" class="mb-3">
										<!-- Deviations will be populated here -->
									</div>
									
									<div class="mb-2">
										<label class="text-muted small">QC Comment / Instructions</label>
										<div id="mk-qc-detail-comment" class="border rounded p-2 bg-light" style="min-height: 60px;"></div>
									</div>
									
									<div class="text-muted small">
										Last updated by <span id="mk-qc-detail-updated-by"></span> on <span id="mk-qc-detail-updated-on"></span>
									</div>
								</div>
							</div>
						</div>
						
						<!-- QC Feedback Card (for detailed view) -->
						<div class="mk-qc-feedback hide" id="mk-qc-feedback" style="margin-top: 20px;">
							<div class="card">
								<div class="card-body">
									<div class="d-flex justify-content-between align-items-center mb-2">
										<div>
											<h5 class="mb-0">
												QC Feedback â€“ <span id="mk-qc-sample-label"></span>
											</h5>
											<small class="text-muted">
												Batch: <span id="mk-qc-batch"></span> |
												Alloy: <span id="mk-qc-alloy"></span> |
												Product: <span id="mk-qc-product"></span> |
												Furnace: <span id="mk-qc-furnace"></span>
											</small>
										</div>
										<span id="mk-qc-status-badge" class="badge badge-secondary"></span>
									</div>

									<div class="row">
										<!-- Left: QC comment -->
										<div class="col-md-5 mb-3">
											<label class="text-muted small">QC Comment / Instructions to Melting</label>
											<div id="mk-qc-comment" class="border rounded p-2 bg-light" style="min-height: 72px; white-space: pre-wrap;"></div>
										</div>

										<!-- Right: deviation list -->
										<div class="col-md-7 mb-3">
											<label class="text-muted small">Specification Deviations</label>
											<div id="mk-qc-deviation-list" class="mk-qc-deviation-list">
												<!-- filled dynamically -->
											</div>
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>

					<!-- Transfer Tab -->
					<div id="mk_tab_transfer" class="mk-tab-pane">
						<div id="mk_transfer_form"></div>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>
